---
title: "Preparing the PEM database server"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/installation-getting-started/pgbouncer-configuration-guide/8.0/preparing_the_pem_database_server.html"
redirects:
  - /pem/latest/pem_pgbouncer/02_preparing_the_pem_database_server/
  - /pem/latest/pem_online_help/09_toc_pem_configure_pgbouncer/02_pem_pgbouncer_preparing_dbserver/
---

You must configure dedicated users and create an SSL key and certificate on the PEM database server to enable connection pooling for PEM with PgBouncer. 

This example shows how to prepare the PEM database server.

## Creating users and roles for PgBouncer-PEM connections

1.  Create a dedicated user named pgbouncer with `pem_agent_pool` membership on the PEM database server:

    ```sql
    CREATE ROLE pgbouncer PASSWORD 'ANY_PASSWORD' LOGIN;
    __OUTPUT__
    CREATE ROLE
    ```

    ```sql
    GRANT pem_agent_pool TO pgbouncer;
    __OUTPUT__
    GRANT ROLE
    ```

1.  Create a user named pem_admin1 (not a superuser) with `pem_admin` and `pem_agent_pool role` membership on the PEM database server:

    ```sql
    CREATE ROLE pem_admin1 PASSWORD 'ANY_PASSWORD' LOGIN CREATEROLE;
    __OUTPUT__
    CREATE ROLE
    ```

    ```sql
    GRANT pem_agent_pool TO pem_admin1;
    __OUTPUT__
    GRANT ROLE
    ```

    ```sql
    GRANT pem_admin TO pem_admin1 WITH ADMIN OPTION;
    __OUTPUT__
    GRANT ROLE
    ```

1.  Grant CONNECT privileges to the pgbouncer user on the `pem` database:

    ```sql
    GRANT CONNECT ON DATABASE pem TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

1.  Grant USAGE privileges to the pgbouncer user for the `pem` schema on the `pem` database:

    ```sql
    GRANT USAGE ON SCHEMA pem TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

1.  Grant EXECUTE privileges to the pgbouncer user on the `pem.get_agent_pool_auth(text)` function in the `pem` database. For example:

    ```sql
    GRANT EXECUTE ON FUNCTION pem.get_agent_pool_auth(text) TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

1.  Use the `pem.create_proxy_agent_user(varchar)` function to create a user named pem_agent_user1 on the PEM database server:

    ```sql
    SELECT pem.create_proxy_agent_user('pem_agent_user1');
    __OUTPUT__
    create_proxy_agent_user
    -------------------------
    (1 row)
    ```

    The function creates a user with the same name and a random password and grants pem_agent and pem_agent_pool roles to the user. This approach allows PgBouncer to use a proxy user on behalf of the agent.

## Updating the configuration files to allow PgBouncer-PEM connections

1.  Allow the pgbouncer user to connect to the `pem` database using the SSL authentication method by adding the following entry to the `pg_hba.conf` file of the PEM database server:

    !!!note
       Add the following entry before any `+pem_agent` entries
    !!!

    ```shell
    # Allow the PEM agent proxy user (used by pgbouncer) 
    # to connect the to PEM server using SSL

    hostssl pem     +pem_agent_pool 127.0.0.1/32  cert map=pem_agent_pool
    ```

1.  Allow the PEM server to map all users involved in PgBouncer-PEM connections by adding these lines to the `$PGDATA/pg_ident.conf` user mapping file:

    ```shell
    pem_agent_pool  pem_agent_pool  pem_agent_user1
    pem_agent_pool  pem_agent_pool  pem_admin1
    pem_agent_pool  pem_agent_pool  pgbouncer
    ```

1.  Reload the PEM server's configuration:

    ```shell
    pg_ctl reload -D $PGDATA 
    ``` 

## Creating the SSL key and certificate for PgBouncer-PEM authentication

Create a key and certificate for the `pem_agent_pool` group role. Then, move the files to the PgBouncer instance to allow bilateral authentication between the PEM instance and PgBouncer.

1.  Create the signing key with openssl:

    ```shell
    openssl genrsa -out pem_agent_pool.key 4096
    ```

1.  Create a certificate-signing request (CSR). Replace the `-subj` attributes in `<...>` as required. Ensure the Common Name (CN) is set to the `pem_agent_pool` group role name:
  
    ```shell
    openssl req -new -key pem_agent_pool.key -out pem_agent_pool.csr -subj '/C=<COUNTRY>/ST=<STATE>/L=<LOCATION>/O=<ORGANISATION>/CN=pem_agent_pool'
    ```

1.  Use the PEM CA and key to sign the CSR:

    ```
    openssl x509 -req -days 365 -in pem_agent_pool.csr -CA /var/lib/edb/as16/data/ca_certificate.crt -CAkey /var/lib/edb/as16/data/ca_key.key -CAcreateserial -out pem_agent_pool.crt
    ```

1.  Move the created key and certificate to the pgbouncer user's `~/.postgresql` directory and ensure the `enterprisedb` user has permissions:

    ```
    mkdir -p /var/lib/edb/.postgresql
    mv pem_agent_pool.key pem_agent_pool.crt /var/lib/edb/.postgresql
    chmod 0600 /var/lib/edb/.postgresql/pem_agent_pool.key
    chmod 0644 /var/lib/edb/.postgresql/pem_agent_pool.crt
    chown enterprisedb:enterprisedb /var/lib/edb/.postgresql/pem_agent_pool.*
    ```
