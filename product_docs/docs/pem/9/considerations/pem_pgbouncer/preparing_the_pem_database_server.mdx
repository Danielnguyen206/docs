---
title: "Preparing the PEM database server"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/installation-getting-started/pgbouncer-configuration-guide/8.0/preparing_the_pem_database_server.html"
redirects:
  - /pem/latest/pem_pgbouncer/02_preparing_the_pem_database_server/
  - /pem/latest/pem_online_help/09_toc_pem_configure_pgbouncer/02_pem_pgbouncer_preparing_dbserver/
---

You must configure the PEM database server to work with PgBouncer. This example shows how to configure the PEM database server.

1.  Create a dedicated user named pgbouncer with `pem_agent_pool` membership on the PEM database server:

    ```sql
    CREATE ROLE pgbouncer PASSWORD 'ANY_PASSWORD' LOGIN;
    __OUTPUT__
    CREATE ROLE
    ```

    ```sql
    GRANT pem_agent_pool TO pgbouncer;
    __OUTPUT__
    GRANT ROLE
    ```

2.  Create a user named pem_admin1 (not a superuser) with `pem_admin` and `pem_agent_pool role` membership on the PEM database server:

    ```sql
    CREATE ROLE pem_admin1 PASSWORD 'ANY_PASSWORD' LOGIN CREATEROLE;
    __OUTPUT__
    CREATE ROLE
    ```

    ```sql
    GRANT pem_agent_pool TO pem_admin1;
    __OUTPUT__
    GRANT ROLE
    ```

    ```sql
    GRANT pem_admin TO pem_admin1 WITH ADMIN OPTION;
    __OUTPUT__
    GRANT ROLE
    ```

3.  Grant CONNECT privileges to the pgbouncer user on the `pem` database:

    ```sql
    GRANT CONNECT ON DATABASE pem TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

4.  Grant USAGE privileges to the pgbouncer user for the `pem` schema on the `pem` database:

    ```sql
    GRANT USAGE ON SCHEMA pem TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

5.  Grant EXECUTE privileges to the pgbouncer user on the `pem.get_agent_pool_auth(text)` function in the `pem` database. For example:

    ```sql
    GRANT EXECUTE ON FUNCTION pem.get_agent_pool_auth(text) TO pgbouncer;
    __OUTPUT__
    GRANT
    ```

6.  Use the `pem.create_proxy_agent_user(varchar)` function to create a user named pem_agent_user1 on the PEM database server:

    ```sql
    SELECT pem.create_proxy_agent_user('pem_agent_user1');
    __OUTPUT__
    create_proxy_agent_user
    -------------------------
    (1 row)
    ```

    The function creates a user with the same name and a random password and grants pem_agent and pem_agent_pool roles to the user. This approach allows pgBouncer to use a proxy user on behalf of the agent.

7.  Add the following entries to the start of the `pg_hba.conf` file of the PEM database server. These entries allow the pgBouncer user to connect to the `pem` database using the md5 authentication method.

    ```shell
    # Allow the PEM agent proxy user (used by
    # pgbouncer) to connect the to PEM server using
    # md5

    local pem pgbouncer,pem_admin1 md5
    ```
